
tree_spec <- decision_tree() %>%
  set_engine("rpart")

class_tree_spec <- tree_spec %>%
  set_mode("classification")
koi$koi_disposition <-as.factor(koi$koi_disposition)
class_tree_fit <- class_tree_spec %>%
  fit(koi$koi_disposition ~ ., data = koi)

class_tree_fit

class_tree_fit %>%
  extract_fit_engine() %>%
  rpart.plot()
#the training accuracy
augment(class_tree_fit, new_data = koi) %>%
  accuracy(truth = koi_disposition, estimate = .pred_class)
#the confusion matrix
augment(class_tree_fit, new_data = koi) %>%
  conf_mat(truth = koi_disposition, estimate = .pred_class)

#fitting the model on training data

class_tree_fit <- fit(class_tree_spec, koi_disposition ~ ., data = train.koi)

class_tree_wf <- workflow() %>%
  add_model(class_tree_spec %>% set_args(cost_complexity = tune())) %>%
  add_formula(koi_disposition ~ .)

koi_fold <- vfold_cv(train.koi)

param_grid <- grid_regular(cost_complexity(range = c(-3, -1)), levels = 10)

tune_res <- tune_grid(
  class_tree_wf, 
  resamples = koi_fold, 
  grid = param_grid, 
  metrics = metric_set(accuracy))

autoplot(tune_res)

best_complexity <- select_best(tune_res)

class_tree_final <- finalize_workflow(class_tree_wf, best_complexity)

class_tree_final_fit <- fit(class_tree_final, data = train.koi)
class_tree_final_fit

class_tree_final_fit %>%
  extract_fit_engine() %>%
  rpart.plot()
